(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))s(c);new MutationObserver(c=>{for(const l of c)if(l.type==="childList")for(const t of l.addedNodes)t.tagName==="LINK"&&t.rel==="modulepreload"&&s(t)}).observe(document,{childList:!0,subtree:!0});function n(c){const l={};return c.integrity&&(l.integrity=c.integrity),c.referrerPolicy&&(l.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?l.credentials="include":c.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(c){if(c.ep)return;c.ep=!0;const l=n(c);fetch(c.href,l)}})();const g=9,h=10,y=70,x=35,v=0,P=1,Q={g:["帥","將"],a:["仕","士"],e:["相","象"],h:["傌","馬"],r:["俥","車"],c:["炮","砲"],s:["兵","卒"]};let a=[],R=v,T=null,k=!1,H="pvp",D=P,S="medium",V=null,O=[];const N=new(window.AudioContext||window.webkitAudioContext);function q(o){const e=N.createOscillator(),n=N.createGain();e.connect(n),n.connect(N.destination);const s=N.currentTime;o==="move"?(e.type="sine",e.frequency.setValueAtTime(600,s),e.frequency.exponentialRampToValueAtTime(400,s+.1),n.gain.setValueAtTime(.1,s),n.gain.exponentialRampToValueAtTime(.01,s+.1),e.start(s),e.stop(s+.1)):o==="capture"?(e.type="square",e.frequency.setValueAtTime(300,s),e.frequency.exponentialRampToValueAtTime(100,s+.2),n.gain.setValueAtTime(.1,s),n.gain.exponentialRampToValueAtTime(.01,s+.2),e.start(s),e.stop(s+.2)):o==="check"&&(e.type="triangle",e.frequency.setValueAtTime(800,s),e.frequency.setValueAtTime(400,s+.1),e.frequency.setValueAtTime(800,s+.2),e.frequency.setValueAtTime(400,s+.3),n.gain.setValueAtTime(.1,s),n.gain.linearRampToValueAtTime(.1,s+.4),n.gain.linearRampToValueAtTime(0,s+.5),e.start(s),e.stop(s+.5))}function Y(){te(),$(),b()}function b(){document.getElementById("btn-pvp")?.addEventListener("click",()=>K("pvp")),document.getElementById("btn-pve")?.addEventListener("click",()=>K("pve")),document.getElementById("btn-restart")?.addEventListener("click",()=>$()),document.getElementById("difficulty-select")?.addEventListener("change",o=>{S=o.target.value})}function $(){a=Array(h).fill(null).map(()=>Array(g).fill(null)),R=v,k=!1,T=null,V=null,O=[],L("紅方回合"),ee(),B(),G()}function K(o){H=o;const e=document.getElementById("btn-pvp"),n=document.getElementById("btn-pve"),s=document.getElementById("difficulty-container");e&&(e.className=o==="pvp"?"active":""),n&&(n.className=o==="pve"?"active":""),s&&(s.style.display=o==="pve"?"flex":"none"),$()}function ee(){const o=[["r","h","e","a","g","a","e","h","r"],[null,null,null,null,null,null,null,null,null],[null,"c",null,null,null,null,null,"c",null],["s",null,"s",null,"s",null,"s",null,"s"],[null,null,null,null,null,null,null,null,null]];for(let e=0;e<5;e++)for(let n=0;n<9;n++){const s=o[e][n];s&&(a[e][n]={type:s,color:P})}for(let e=0;e<5;e++)for(let n=0;n<9;n++){const s=o[e][n];s&&(a[9-e][n]={type:s,color:v})}}function te(){const o=document.getElementById("grid-layer");if(o){for(let e=0;e<9;e++){let n=document.createElement("div");n.className="h-line",n.style.top=e*y+"px",o.appendChild(n)}for(let e=0;e<8;e++)if(e===0){let n=document.createElement("div");n.className="v-line",n.style.left=e*y+"px",n.style.height=9*y+"px",o.appendChild(n)}else{let n=document.createElement("div");n.className="v-line",n.style.left=e*y+"px",n.style.height=4*y+"px",o.appendChild(n);let s=document.createElement("div");s.className="v-line",s.style.left=e*y+"px",s.style.top=5*y+"px",s.style.height=4*y+"px",o.appendChild(s)}w(o,3,0,5,2),w(o,5,0,3,2),w(o,3,9,5,7),w(o,5,9,3,7)}}function w(o,e,n,s,c){const l=e*y,t=n*y,r=s*y,i=c*y,d=Math.sqrt((r-l)**2+(i-t)**2),u=Math.atan2(i-t,r-l)*180/Math.PI,f=document.createElement("div");f.className="palace-line",f.style.width=d+"px",f.style.left=l+"px",f.style.top=t+"px",f.style.transform=`rotate(${u}deg)`,o.appendChild(f)}function B(){const o=document.getElementById("pieces-layer");if(o){o.innerHTML="",V&&[{r:V.fromR,c:V.fromC},{r:V.toR,c:V.toC}].forEach(e=>{const n=document.createElement("div");n.className="last-move-marker",n.style.left=x+e.c*y+"px",n.style.top=x+e.r*y+"px",n.innerHTML='<div class="corner-bottom-left"></div><div class="corner-bottom-right"></div>',o.appendChild(n)});for(let e=0;e<h;e++)for(let n=0;n<g;n++){const s=a[e][n];if(s){const c=document.createElement("div");c.className=`piece ${s.color===v?"red":"black"}`,c.innerText=Q[s.type][s.color],c.style.left=x+n*y+"px",c.style.top=x+e*y+"px",c.onclick=()=>F(e,n),T&&T.r===e&&T.c===n&&c.classList.add("selected"),o.appendChild(c)}else{const c=document.createElement("div");c.style.position="absolute",c.style.width="40px",c.style.height="40px",c.style.left=x+n*y-20+"px",c.style.top=x+e*y-20+"px",c.style.cursor="pointer",c.style.zIndex="5",c.onclick=()=>F(e,n),o.appendChild(c)}}}}function oe(o){const e=document.getElementById("highlight-layer");e&&(e.innerHTML="",o.forEach(n=>{const s=document.createElement("div");s.className="dot",s.style.left=x+n.c*y+"px",s.style.top=x+n.r*y+"px",e.appendChild(s)}))}function G(){const o=document.getElementById("highlight-layer");o&&(o.innerHTML="")}function L(o){const e=document.getElementById("status");e&&(e.innerText=o)}function F(o,e){if(k||H==="pve"&&R===D)return;const n=a[o][e];if(n&&n.color===R){T={r:o,c:e},B();const s=E(o,e,a);oe(s);return}T&&E(T.r,T.c,a).find(l=>l.r===o&&l.c===e)&&(j(T.r,T.c,o,e),T=null,G(),!k&&H==="pve"&&R===D&&setTimeout(ge,100))}function j(o,e,n,s){const c=a[n][s];V={fromR:o,fromC:e,toR:n,toC:s};const l=R;if(q(c?"capture":"move"),c&&c.type==="g"){k=!0,B(),L(`遊戲結束! ${R===v?"紅方":"黑方"}勝利!`),a[n][s]=a[o][e],a[o][e]=null,B();return}a[n][s]=a[o][e],a[o][e]=null;const t=z(a,l),r=W(a);if(O.push({boardSig:r,move:V,color:l,isCheck:t.isCheck,chaseType:t.chaseType}),ce(r,l),k){B();return}if(R=1-R,!k&&!ke(a,R)){k=!0,B(),L(`${R===v?"紅方":"黑方"}無合法著法 - ${R===v?"黑方":"紅方"}勝!`);return}B(),!k&&_(R,a)?(q("check"),L((R===v?"紅方":"黑方")+"回合 - 將軍!")):k||L(R===v?"紅方回合":"黑方回合")}function _(o,e){let n=-1,s=-1;for(let l=0;l<h;l++){for(let t=0;t<g;t++){const r=e[l][t];if(r&&r.type==="g"&&r.color===o){n=l,s=t;break}}if(n!==-1)break}if(n===-1)return!1;const c=1-o;for(let l=0;l<h;l++)for(let t=0;t<g;t++){const r=e[l][t];if(r&&r.color===c&&E(l,t,e).some(d=>d.r===n&&d.c===s))return!0}return!1}function E(o,e,n){const s=n[o][e];if(!s)return[];let c=[];const l=s.type,t=s.color,r=(i,d)=>{if(i<0||i>=h||d<0||d>=g)return;const u=n[i][d];(!u||u.color!==t)&&c.push({r:i,c:d})};if(l==="g"){const i=[-1,1,0,0],d=[0,0,-1,1];for(let f=0;f<4;f++){const p=o+i[f],m=e+d[f];m>=3&&m<=5&&(t===v&&p>=7&&p<=9||t===P&&p>=0&&p<=2)&&r(p,m)}const u=t===v?-1:1;for(let f=o+u;f>=0&&f<h;f+=u)if(n[f][e]){n[f][e].type==="g"&&c.push({r:f,c:e});break}}else if(l==="a"){const i=[-1,1,-1,1],d=[-1,-1,1,1];for(let u=0;u<4;u++){const f=o+i[u],p=e+d[u];p>=3&&p<=5&&(t===v&&f>=7&&f<=9||t===P&&f>=0&&f<=2)&&r(f,p)}}else if(l==="e"){const i=[-2,2,-2,2],d=[-2,-2,2,2],u=[-1,1,-1,1],f=[-1,-1,1,1];for(let p=0;p<4;p++){const m=o+i[p],C=e+d[p];t===v&&m<5||t===P&&m>4||m>=0&&m<h&&C>=0&&C<g&&(n[o+u[p]][e+f[p]]||r(m,C))}}else if(l==="h"){const i=[-2,-2,2,2,-1,1,-1,1],d=[-1,1,-1,1,-2,-2,2,2],u=[-1,-1,1,1,0,0,0,0],f=[0,0,0,0,-1,-1,1,1];for(let p=0;p<8;p++){const m=o+i[p],C=e+d[p],M=o+u[p],A=e+f[p];m>=0&&m<h&&C>=0&&C<g&&(n[M][A]||r(m,C))}}else if(l==="r"){const i=[[0,1],[0,-1],[1,0],[-1,0]];for(let d of i){let u=o+d[0],f=e+d[1];for(;u>=0&&u<h&&f>=0&&f<g;){if(!n[u][f])c.push({r:u,c:f});else{n[u][f].color!==t&&c.push({r:u,c:f});break}u+=d[0],f+=d[1]}}}else if(l==="c"){const i=[[0,1],[0,-1],[1,0],[-1,0]];for(let d of i){let u=o+d[0],f=e+d[1],p=!1;for(;u>=0&&u<h&&f>=0&&f<g;){if(!n[u][f])p||c.push({r:u,c:f});else if(!p)p=!0;else{n[u][f].color!==t&&c.push({r:u,c:f});break}u+=d[0],f+=d[1]}}}else l==="s"&&(r(o+(t===v?-1:1),e),(t===v&&o<=4||t===P&&o>=5)&&(r(o,e-1),r(o,e+1)));return c}function W(o){return o.map(e=>e.map(n=>n?`${n.color}${n.type}`:"_").join("")).join("/")}function ne(o,e,n,s){const c=o[e][n];o[e][n]={type:"s",color:1-s};let l=!1;for(let t=0;t<h;t++){for(let r=0;r<g;r++){const i=o[t][r];if(i&&i.color===s&&E(t,r,o).some(u=>u.r===e&&u.c===n)){l=!0;break}}if(l)break}return o[e][n]=c,l}function se(o,e,n,s){const c=o[e][n];o[e][n]=null;const l=_(s,o);return o[e][n]=c,l}function z(o,e){const n=_(1-e,o);let s="none";const c=1-e;for(let l=0;l<h;l++)for(let t=0;t<g;t++){const r=o[l][t];if(r&&r.color===c&&r.type!=="g"){let i=!1;for(let d=0;d<h;d++){for(let u=0;u<g;u++){const f=o[d][u];if(f&&f.color===e&&E(d,u,o).some(m=>m.r===l&&m.c===t)){i=!0;break}}if(i)break}if(i)if(ne(o,l,t,c)){let u=!1;const f=o[l][t];o[l][t]={type:"s",color:e};for(let p=0;p<h;p++){for(let m=0;m<g;m++){const C=o[p][m];if(C&&C.color===c&&E(p,m,o).some(A=>A.r===l&&A.c===t)&&!se(o,p,m,c)){u=!0;break}}if(u)break}if(o[l][t]=f,u)s==="none"&&(s="rooted");else return{isCheck:n,chaseType:"rootless"}}else return{isCheck:n,chaseType:"rootless"}}}return{isCheck:n,chaseType:s}}function U(o,e,n){const s=o.filter(c=>c.boardSig===e);if(s.length>=2){const c=o.findIndex(p=>p.boardSig===e);if(c===-1)return{violation:!1,msg:"",isDraw:!1};const t=o.slice(c).filter(p=>p.color===n),r=t.some(p=>p.isCheck),i=t.some(p=>p.chaseType==="rootless"),d=t.some(p=>p.chaseType==="rooted");let u=!1,f="";if(r&&i||r&&d?(u=!0,f="一將一捉"):r?t.some(m=>!m.isCheck&&m.chaseType==="none")||(u=!0,f="長將"):i&&(t.some(m=>!m.isCheck&&m.chaseType==="none")||(u=!0,f="長捉無根子")),u)return{violation:!0,msg:f,isDraw:!1};if(s.length>=3)return{violation:!1,msg:"雙方不變作和",isDraw:!0}}return{violation:!1,msg:"",isDraw:!1}}function ce(o,e){const n=U(O,o,e);n.violation?(k=!0,L(`${e===v?"紅方":"黑方"} ${n.msg} - 判負!`)):n.isDraw&&(k=!0,L(n.msg))}const le=1e4,re=900,ie=450,fe=400,ae=20,ue=20,de=30,pe=[[9,9,9,11,13,11,9,9,9],[19,24,34,42,44,42,34,24,19],[19,24,32,37,37,37,32,24,19],[19,23,27,29,30,29,27,23,19],[14,18,20,27,29,27,20,18,14],[7,0,13,0,16,0,13,0,7],[7,0,7,0,15,0,7,0,7],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0]],me=[[4,8,16,12,4,12,16,8,4],[4,10,28,16,8,16,28,10,4],[12,14,23,25,25,25,23,14,12],[10,24,34,40,40,40,34,24,10],[6,16,26,36,36,36,26,16,6],[2,10,18,24,24,24,18,10,2],[4,6,10,14,14,14,10,6,4],[0,4,8,10,10,10,8,4,0],[2,-4,4,8,8,8,4,-4,2],[0,-4,0,0,0,0,0,-4,0]],ye=[[6,6,6,8,10,8,6,6,6],[4,6,6,6,6,6,6,6,4],[2,4,4,4,8,4,4,4,2],[0,2,2,2,2,2,2,2,0],[0,0,0,0,0,0,0,0,0],[-2,0,4,0,8,0,4,0,-2],[0,0,0,0,0,0,0,0,0],[2,2,4,10,12,10,4,2,2],[2,2,0,2,0,2,0,2,2],[0,0,0,0,0,0,0,0,0]],he=[[14,14,12,18,16,18,12,14,14],[16,20,18,24,26,24,18,20,16],[12,12,12,18,18,18,12,12,12],[12,18,16,22,22,22,16,18,12],[12,16,14,18,18,18,14,16,12],[12,16,16,18,18,18,16,16,12],[6,10,12,14,14,14,12,10,6],[4,8,8,14,14,14,8,8,4],[0,4,6,10,10,10,6,4,0],[-2,2,4,6,6,6,4,2,-2]];function ve(o,e,n,s){const c=s===v?e:9-e,l=n;switch(o){case"s":return pe[c][l];case"h":return me[c][l];case"c":return ye[c][l];case"r":return he[c][l];default:return 0}}function ge(){if(k)return;let o=4;if(S==="easy"&&(o=2),S==="hard"){o=5;let n=0;for(let s=0;s<h;s++)for(let c=0;c<g;c++)a[s][c]&&n++;n>28?o=4:n<17&&(o=6)}const e=Re(o,D);e?j(e.fromR,e.fromC,e.toR,e.toC):console.log("AI has no moves")}function Ce(o,e){let n=0,s=!1,c=!1;for(let l=0;l<h;l++)for(let t=0;t<g;t++){const r=o[l][t];if(r){let i=0;switch(r.type){case"g":i=le,r.color===e?s=!0:c=!0;break;case"r":i=re;break;case"c":i=ie;break;case"h":i=fe;break;case"e":i=ae;break;case"a":i=ue;break;case"s":i=de;break}i+=ve(r.type,l,t,r.color);const d=E(l,t,o);i+=d.length*2,r.color===e?n+=i:n-=i}}return s?c?n:1e6:-1e6}function Re(o,e){const s=Z(a,e).filter(t=>{const r=a[t.toR][t.toC];a[t.toR][t.toC]=a[t.fromR][t.fromC],a[t.fromR][t.fromC]=null;const i=z(a,e),d=W(a),u=[...O,{boardSig:d,move:t,color:e,isCheck:i.isCheck,chaseType:i.chaseType}],f=U(u,d,e);return a[t.fromR][t.fromC]=a[t.toR][t.toC],a[t.toR][t.toC]=r,!f.violation});for(const t of s){const r=a[t.toR][t.toC];if(r&&r.type==="g")return t}let c=-1/0,l;s.sort((t,r)=>{const i=a[t.toR][t.toC],d=a[t.fromR][t.fromC],u=i&&I[i.type]||0,f=d&&I[d.type]||0,p=u*10-f,m=a[r.toR][r.toC],C=a[r.fromR][r.fromC],M=m&&I[m.type]||0,A=C&&I[C.type]||0;return M*10-A-p});for(const t of s){const r=a[t.toR][t.toC];a[t.toR][t.toC]=a[t.fromR][t.fromC],a[t.fromR][t.fromC]=null;const i=-X(o-1,-1/0,1/0,1-e);a[t.fromR][t.fromC]=a[t.toR][t.toC],a[t.toR][t.toC]=r,i>c&&(c=i,l=t)}return l}function X(o,e,n,s){if(o===0)return Ce(a,s);const c=Z(a,s);if(c.length===0)return-1e6-o;c.sort((t,r)=>{const i=a[t.toR][t.toC],d=a[t.fromR][t.fromC],u=i&&I[i.type]||0,f=d&&I[d.type]||0,p=u*10-f,m=a[r.toR][r.toC],C=a[r.fromR][r.fromC],M=m&&I[m.type]||0,A=C&&I[C.type]||0;return M*10-A-p});let l=-1/0;for(const t of c){const r=a[t.toR][t.toC];if(r&&r.type==="g"){a[t.toR][t.toC]=a[t.fromR][t.fromC],a[t.fromR][t.fromC]=null;const d=1e6+o;return a[t.fromR][t.fromC]=a[t.toR][t.toC],a[t.toR][t.toC]=r,d}a[t.toR][t.toC]=a[t.fromR][t.fromC],a[t.fromR][t.fromC]=null;const i=-X(o-1,-n,-e,1-s);if(a[t.fromR][t.fromC]=a[t.toR][t.toC],a[t.toR][t.toC]=r,i>l&&(l=i),e=Math.max(e,i),e>=n)break}return l}const I={g:1e4,r:900,c:450,h:400,e:20,a:20,s:30};function Z(o,e){let n=[];for(let s=0;s<h;s++)for(let c=0;c<g;c++){const l=o[s][c];l&&l.color===e&&E(s,c,o).forEach(r=>{n.push({fromR:s,fromC:c,toR:r.r,toC:r.c})})}return n}function ke(o,e){for(let n=0;n<h;n++)for(let s=0;s<g;s++){const c=o[n][s];if(c&&c.color===e){const l=E(n,s,o);for(const t of l){const r=o[t.r][t.c];o[t.r][t.c]=o[n][s],o[n][s]=null;const i=_(e,o);if(o[n][s]=o[t.r][t.c],o[t.r][t.c]=r,!i)return!0}}}return!1}Y();
